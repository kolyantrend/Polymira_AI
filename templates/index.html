<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymira | Premium AI Terminal (DEVNET)</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://pub-25d67656292c4365ad15436e7162f37f.r2.dev/moonbook.png">
    <link rel="apple-touch-icon" href="https://pub-25d67656292c4365ad15436e7162f37f.r2.dev/moonbook.png">

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;800&display=swap');

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: transparent !important;
            color: #1a1a1a; font-family: 'Inter', sans-serif;
        }


        #bg-video {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -100; object-fit: cover;
        }


        #three-canvas { position: fixed; top: 0; left: 0; z-index: -90; pointer-events: none; }


        .nav-glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }


        .card-container {
            position: relative; border-radius: 1.5rem; padding: 1px;
            background: rgba(255, 255, 255, 0.4);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column;
        }

        .card-inner {
            position: relative; background: #ffffff; border-radius: 1.4rem;
            padding: 1.5rem; height: 100%; color: #0f172a;
            display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }


        .market-link { display: block; text-decoration: none; color: inherit; cursor: pointer; }
        .market-link:hover h3 { color: #2563eb; }


        .prediction-text a { pointer-events: none; color: inherit; text-decoration: none; font-weight: inherit; }


        /* More transparent blur for unpurchased cards */
        .blur-text { filter: blur(4px); opacity: 0.65; transition: all 0.6s ease-out; user-select: none; pointer-events: none; }
        .card-container.unlocked .blur-text { filter: none !important; opacity: 1 !important; user-select: text !important; pointer-events: auto; }

        .tab-active { background-color: #2563eb !important; color: white !important; }
        .btn-buy { background: #2563eb; color: white; }
        .btn-unlocked { background: #22c55e !important; color: white !important; cursor: default; box-shadow: none !important; }

        .like-btn.active svg { fill: #ff3344; stroke: #ff3344; color: #ff3344; }


        .filter-btn {
            font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em;
            padding: 6px 16px; border-radius: 20px; color: #64748b; background: rgba(255,255,255,0.5);
            transition: all 0.3s;
        }
        .filter-btn.active { background: #2563eb; color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }


        /* 16:9 ratio for images */
        .card-image-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            overflow: hidden;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }


        .card-image-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }


        .card-image-container:hover img {
            transform: scale(1.05);
        }


        /* Category tags colors */
        .category-tag {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            padding: 0.25rem 0.75rem;
            font-size: 9px;
            font-weight: 800;
            border-radius: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: white;
        }


        .cat-finance { background: linear-gradient(135deg, #10b981, #059669); }
        .cat-politics { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .cat-economy { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .cat-earnings { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .cat-elections { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .cat-tech { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .cat-geopolitics { background: linear-gradient(135deg, #ec4899, #db2777); }
        .cat-world { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .cat-crypto { background: linear-gradient(135deg, #f97316, #ea580c); }
        .cat-sports { background: linear-gradient(135deg, #84cc16, #65a30d); }
        .cat-mentions { background: linear-gradient(135deg, #a855f7, #9333ea); }
        .cat-culture { background: linear-gradient(135deg, #14b8a6, #0d9488); }
        .cat-general { background: linear-gradient(135deg, #64748b, #475569); }


        .lb-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 2rem;
            padding: 2.5rem;
            color: #1e293b;
        }

        .period-btn { font-size: 10px; font-weight: 800; padding: 5px 12px; border-radius: 8px; transition: 0.3s; }
        .period-btn.active { background: #2563eb; color: white; }
        .cat-btn { font-weight: 800; font-size: 11px; color: #94a3b8; border-bottom: 2px solid transparent; transition: 0.3s; }
        .cat-btn.active { color: #2563eb; border-color: #2563eb; }


        /* Mobile optimization */
        @media (max-width: 768px) {
            .nav-glass { padding: 0 0.75rem; height: 4rem; }
            .nav-glass img { height: 1.25rem; }
            #connectBtn { padding: 0.5rem 0.75rem; font-size: 7px; letter-spacing: 0.05em; }
            #header-avatar { width: 1.75rem; height: 1.75rem; }

            .card-inner { padding: 1rem; }
            .card-inner h3 { font-size: 1rem; }

            .lb-section {
                padding: 1.5rem;
                border-radius: 1.5rem;
                margin: 0 0.5rem;
            }

            .lb-section h2 { font-size: 1.25rem; }

            .flex.justify-between.items-center.mb-10 {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
                margin-bottom: 1.5rem;
            }

            .period-btn { font-size: 8px; padding: 4px 8px; }

            .flex.gap-6.mb-8 {
                gap: 1rem;
                flex-wrap: wrap;
                overflow-x: auto;
                white-space: nowrap;
            }

            .cat-btn { font-size: 9px; padding: 0.5rem; }

            #lb-list > div {
                padding: 0.75rem;
                flex-wrap: wrap;
            }

            #lb-list img { width: 2rem; height: 2rem; }
            #lb-list .flex.items-center.gap-4 { gap: 0.75rem; }
            #lb-list p { font-size: 0.75rem; }
            #lb-list span.font-black.text-sm { font-size: 0.875rem; }
            #lb-list span.w-6 { width: 1.5rem; font-size: 0.875rem; }

            .bg-white\/20.backdrop-blur-md {
                padding: 0.75rem;
                gap: 0.25rem;
            }

            .bg-white\/20 button {
                padding: 0.5rem 0.75rem;
                font-size: 9px;
                white-space: nowrap;
            }

            #sub-filters { gap: 0.5rem; }
            .filter-btn { padding: 5px 12px; font-size: 9px; }

            #profileModal > div {
                width: 90%;
                max-width: 350px;
                padding: 2rem;
            }

            #shareModal > div {
                width: 90%;
                max-width: 350px;
                padding: 1.5rem;
            }
        }


        @media (max-width: 480px) {
            .nav-glass { height: 3.5rem; }
            .lb-section { padding: 1rem; }
            #lb-list > div { padding: 0.5rem; }

            .bg-white\/20 button {
                padding: 0.4rem 0.6rem;
                font-size: 8px;
            }
            
            /* Hide 'WALLET' text on very small screens to save space */
            #connectBtn span { display: none; }
        }
    </style>
</head>
<body>


    <video id="bg-video" autoplay muted loop playsinline>
        <source src="{{ assets.bg_video }}" type="video/mp4">
    </video>

    <canvas id="three-canvas"></canvas>


    <header class="sticky top-0 z-50 nav-glass h-16 flex items-center px-4 md:px-8 justify-between">
        <img src="{{ assets.logo }}" class="h-6 md:h-8 cursor-pointer" onclick="location.reload()">
        <div class="flex items-center gap-2 md:gap-6">
            <!-- Link to X (Twitter) -->
            <a href="https://x.com/Polymira" target="_blank" rel="noopener noreferrer" class="text-white/60 hover:text-white transition-colors">
                <i data-lucide="twitter" class="w-4 h-4 md:w-5 md:h-5"></i>
            </a>
            <button onclick="openProfile()" class="text-white/60 hover:text-white transition-colors">
                <i data-lucide="settings" class="w-4 h-4 md:w-5 md:h-5"></i>
            </button>
            <button id="connectBtn" onclick="handleWalletClick()" class="bg-white text-blue-600 px-3 md:px-6 py-2 rounded-full font-black text-[9px] md:text-[10px] tracking-widest hover:bg-blue-600 hover:text-white transition-all whitespace-nowrap">CONNECT <span>WALLET</span></button>
            <img id="header-avatar" src="{{ assets.avatar }}" class="h-8 w-8 md:h-10 md:w-10 rounded-full border-2 border-white object-cover cursor-pointer" onclick="openProfile()">
        </div>
    </header>


    <main class="container mx-auto px-6 py-12">
        <div class="flex flex-col items-center mb-10">
            <div class="bg-white/20 backdrop-blur-md p-1.5 rounded-2xl flex gap-2 border border-white/30 mb-6">
                <button id="feedTab" onclick="switchTab('feed')" class="px-10 py-3 rounded-xl text-xs font-black uppercase tracking-widest transition-all tab-active">Live Feed</button>
                <button id="ordersTab" onclick="switchTab('orders')" class="px-10 py-3 rounded-xl text-xs font-black uppercase tracking-widest text-white hover:text-blue-200">Unlocked</button>
                <button id="lbTab" onclick="switchTab('lb')" class="px-10 py-3 rounded-xl text-xs font-black uppercase tracking-widest text-white hover:text-blue-200">Ranking</button>
            </div>
            <div id="sub-filters" class="flex gap-3">
                <button onclick="filterFeed('new', this)" class="filter-btn active">New ‚ú®</button>
                <button onclick="filterFeed('hot', this)" class="filter-btn">Hot üî•</button>
            </div>
        </div>


        <div id="grid" class="grid grid-cols-1 md:grid-cols-3 gap-10">
            {% for item in forecasts %}
            {% set img_idx = (loop.index0 % 100) + 1 %}
            <div class="card-container forecast-card" id="card-{{ item.id }}" data-id="{{ item.id }}" data-index="{{ loop.index0 }}" data-likes="{{ item.likes|length }}">
                <div class="card-inner">
                    <a href="{{ item.url }}" target="_blank" rel="noopener noreferrer" class="market-link">
                        <div class="card-image-container">
                            <img src="{{ assets.card_base }}%20({{ img_idx }}).jpeg" alt="{{ item.title }}">
                            <div class="category-tag cat-{{ item.category|lower }}">{{ item.category }}</div>
                        </div>
                        <h3 class="text-xl font-black leading-tight mb-4 transition-colors">{{ item.title | safe }}</h3>
                    </a>
                    <div class="blur-text prediction-text text-slate-600 text-[11px] –≥—Ä–∞–Ω–∏—Ü–∞-relaxed mb-8 flex-grow">
                        {{ item.text | safe }}
                    </div>

                    <button id="btn-{{ item.id }}" onclick="handleBuy('{{ item.id }}')" class="buy-btn w-full py-4 btn-buy rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] transition-all active:scale-95 shadow-lg">
                        Unlock for 0.01 SOL (DEV)
                    </button>

                    <div class="mt-6 pt-6 border-t border-slate-100 flex justify-between items-center text-slate-400">
                        <div class="flex gap-4 items-center">
                            <button id="like-btn-{{ item.id }}" onclick="handleLike('{{ item.id }}', this)" class="like-btn flex items-center gap-1.5 hover:text-red-500 transition-colors" autocomplete="off">
                                <i data-lucide="heart" class="w-4 h-4"></i>
                                <span class="like-count text-[11px] font-bold">{{ item.likes|length }}</span>
                            </button>
                            <button onclick="handleShareClick('{{ item.id }}', '{{ item.title }}')" class="hover:text-blue-500">
                                <i data-lucide="share-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="text-[10px] font-bold tracking-tight text-blue-600 italic">POLYMIRA AI</span>
                            <span class="text-[9px] font-semibold text-slate-400">{{ item.created_at }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>


        <!-- Pagination Controls -->
        <div id="pagination-controls"></div>


        <div id="lb-view" class="hidden max-w-5xl mx-auto lb-section">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-2xl font-black uppercase tracking-tighter">üèÜ Terminal Ranking (DEV)</h2>
                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button onclick="changePeriod('day', this)" class="period-btn active bg-white shadow-sm">DAY</button>
                    <button onclick="changePeriod('week', this)" class="period-btn">WEEK</button>
                    <button onclick="changePeriod('month', this)" class="period-btn">MONTH</button>
                    <button onclick="changePeriod('all', this)" class="period-btn">ALL</button>
                </div>
            </div>
            <div class="flex gap-6 mb-8 border-b border-slate-100 pb-2">
                <button onclick="switchLBCat('buyers', this)" class="cat-btn active">TOP BUYERS</button>
                <button onclick="switchLBCat('likers', this)" class="cat-btn">TOP LIKERS</button>
                <button onclick="switchLBCat('sharers', this)" class="cat-btn">TOP SHARERS</button>
            </div>
            <div id="lb-list" class="space-y-4"></div>
        </div>
    </main>


    <div id="profileModal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center backdrop-blur-md">
        <div class="bg-white p-10 rounded-[2.5rem] w-[400px] text-center shadow-2xl">
            <h2 class="text-2xl font-black mb-2 uppercase">Your Profile</h2>
            <p class="text-[10px] text-slate-400 font-bold mb-8 tracking-widest uppercase italic">Settings & Controls</p>
            <div class="mb-6 text-left">
                <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest ml-2 mb-1 block">X / Twitter Handle</label>
                <input id="xInput" type="text" placeholder="@your_handle" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-center outline-none border-2 border-transparent focus:border-blue-500 transition-all">
            </div>
            <button onclick="saveX()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg hover:bg-blue-700 transition-all mb-3">Save Changes</button>
            <button onclick="disconnectWallet()" class="w-full py-4 bg-red-50 text-red-500 hover:bg-red-500 hover:text-white border border-red-100 rounded-2xl font-black text-xs uppercase tracking-widest transition-all mb-6">Disconnect Wallet</button>
            <button onclick="closeProfile()" class="text-[10px] font-bold text-slate-300 uppercase hover:text-slate-500">Close Window</button>
        </div>
    </div>


    <div id="shareModal" class="fixed inset-0 bg-black/90 z-[110] hidden flex items-center justify-center backdrop-blur-lg">
        <div class="bg-white p-8 rounded-[2rem] w-[420px] text-center shadow-2xl border border-white/20">
            <div class="mb-6">
                <div class="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="twitter" class="w-8 h-8 text-blue-500 fill-current"></i>
                </div>
                <h2 class="text-xl font-black mb-2 uppercase tracking-tight">Verify Share</h2>
                <p class="text-[11px] text-slate-500 font-bold leading-relaxed">
                    Paste the link to your published tweet below<br>to verify and claim your ranking points.
                </p>
            </div>
            <input id="shareInput" type="text" placeholder="https://x.com/username/status/..." class="w-full bg-slate-50 border-2 border-slate-100 p-4 rounded-xl font-bold text-xs mb-4 outline-none focus:border-blue-500 focus:bg-white transition-all text-center">
            <button onclick="verifyAndClaimShare()" class="w-full py-4 bg-black text-white rounded-xl font-black text-xs uppercase tracking-widest shadow-xl hover:bg-gray-800 transition-all mb-4">
                Verify & Claim Points
            </button>
            <button onclick="closeShareModal()" class="text-[10px] font-bold text-slate-400 uppercase hover:text-slate-600">Cancel</button>
        </div>
    </div>


    <script>
        lucide.createIcons();
        const DEFAULT_AVATAR = "{{ assets.avatar }}";
        let wallet = null;
        let myUnlocked = [];
        let myLiked = [];
        let currentPeriod = 'day';
        let currentCat = 'buyers';
        let currentTab = 'feed';
        let pendingShareId = null;

        // Pagination variables
        let currentPage = 1;
        const CARDS_PER_PAGE = 12;


        const RECEIVER_WALLET = "2zVz7WF3ejWnCrfsCuK17As8kQqk3Ya7FSdxxoNWr3EY";
        const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'), 'confirmed');


        async function handleWalletClick() {
            if (wallet) {
                openProfile();
                return;
            }

            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const isPhantom = window.solana && window.solana.isPhantom;

            // MOBILE REDIRECT LOGIC
            if (isMobile && !isPhantom) {
                const currentUrl = encodeURIComponent(window.location.href);
                const ref = encodeURIComponent(window.location.origin);
                window.location.href = `https://phantom.app/ul/browse/${currentUrl}?ref=${ref}`;
                return;
            }

            if (!window.solana) {
                const btn = document.getElementById('connectBtn');
                const oldText = btn.innerHTML;
                btn.innerText = "NOT FOUND";
                setTimeout(() => { btn.innerHTML = oldText; }, 2000);
                return;
            }

            try {
                const r = await window.solana.connect();
                wallet = r.publicKey.toString();
                // Update button text with short address
                document.getElementById('connectBtn').innerText = wallet.slice(0,4)+"..."+wallet.slice(-4);
                await fetchUserState();
                updateAvatar();
            } catch(e) {
                console.error("Connection error:", e);
            }
        }


        async function disconnectWallet() {
            if (window.solana) { await window.solana.disconnect(); }
            resetState(); closeProfile();
        }


        function resetState() {
            wallet = null; myUnlocked = []; myLiked = [];
            document.getElementById('connectBtn').innerHTML = "CONNECT <span>WALLET</span>";
            document.getElementById('header-avatar').src = DEFAULT_AVATAR;
            document.getElementById('xInput').value = "";

            document.querySelectorAll('.forecast-card').forEach(c => {
                c.classList.remove('unlocked');
                const btn = document.getElementById('btn-'+c.dataset.id);
                if(btn) {
                    btn.innerText = "Unlock for 0.01 SOL (DEV)";
                    btn.className = "buy-btn w-full py-4 btn-buy rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] transition-all active:scale-95 shadow-lg";
                    btn.onclick = function() { handleBuy(c.dataset.id) };
                }
            });


            document.querySelectorAll('.like-btn').forEach(btn => btn.classList.remove('active'));

            setTimeout(() => {
                document.querySelectorAll('.like-btn').forEach(btn => btn.classList.remove('active'));
            }, 50);


            switchTab('feed');
        }


        async function fetchUserState() {
            if(!wallet) return;
            const res = await fetch(`/api/user_state/${wallet}`);
            const data = await res.json();
            myUnlocked = data.unlocked || [];
            myLiked = data.liked || [];
            updateUI();
            switchTab(currentTab);
        }


        async function updateAvatar() {
            if(!wallet) return;
            const r = await fetch(`/api/profile/${wallet}`);
            const d = await r.json();
            if(d.x) {
                document.getElementById('header-avatar').src = `https://unavatar.io/twitter/${d.x}`;
                document.getElementById('xInput').value = d.x;
            }
        }


        function handleShareClick(id, title) {
            if(!wallet) return alert("Connect wallet first!");

            const card = document.getElementById('card-' + id);
            const marketUrl = card ? card.querySelector('.market-link').href : '';

            const tweetText = `üîÆ AI Prediction on @Polymira:\n\n"${title}"\n${marketUrl}`;

            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`, '_blank');
            pendingShareId = id;
            document.getElementById('shareModal').classList.remove('hidden');
            document.getElementById('shareInput').value = "";
            document.getElementById('shareInput').focus();
        }


        async function verifyAndClaimShare() {
            const link = document.getElementById('shareInput').value.trim();
            const profileHandle = document.getElementById('xInput').value.replace('@', '').trim().toLowerCase();

            if (!profileHandle) {
                alert("Please save your X handle first!");
                return;
            }

            const match = link.match(/https?:\/\/(?:www\.)?(?:twitter|x)\.com\/([a-zA-Z0-9_]+)\/status\/([0-9]+)/);
            if (!match) {
                alert("Invalid X/Twitter link!");
                return;
            }

            const linkUsername = match[1].toLowerCase();

            if (linkUsername !== profileHandle) {
                alert(`Link must be from @${profileHandle}!\n\nYour link is from @${linkUsername}`);
                return;
            }

            await fetch('/share', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({wallet, card_id: pendingShareId})
            });

            alert("Verified! Points added.");
            closeShareModal();
        }


        function closeShareModal() { document.getElementById('shareModal').classList.add('hidden'); pendingShareId = null; }


        function updatePagination() {
            const container = document.getElementById('grid');
            const allCards = Array.from(container.querySelectorAll('.forecast-card'));

            let visibleCards = allCards.filter(c => {
                if (currentTab === 'feed') {
                    return !myUnlocked.includes(c.dataset.id);
                } else if (currentTab === 'orders') {
                    return myUnlocked.includes(c.dataset.id);
                }
                return true;
            });

            const totalPages = Math.ceil(visibleCards.length / CARDS_PER_PAGE);
            const startIdx = (currentPage - 1) * CARDS_PER_PAGE;
            const endIdx = startIdx + CARDS_PER_PAGE;

            allCards.forEach(c => c.style.display = 'none');

            visibleCards.slice(startIdx, endIdx).forEach(c => c.style.display = 'block');

            updatePaginationControls(totalPages);
        }


        function updatePaginationControls(totalPages) {
            let paginationHTML = '';

            if (totalPages <= 1) {
                document.getElementById('pagination-controls').innerHTML = '';
                return;
            }

            paginationHTML = '<div class="flex items-center justify-center gap-2 mt-10">';

            if (currentPage > 1) {
                paginationHTML += `<button onclick="changePage(${currentPage - 1})" class="px-4 py-2 bg-white/20 text-white rounded-xl font-bold text-xs hover:bg-white/30 transition-all">‚Üê Prev</button>`;
            }

            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="px-4 py-2 bg-blue-600 text-white rounded-xl font-bold text-xs">${i}</button>`;
                } else if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 1) {
                    paginationHTML += `<button onclick="changePage(${i})" class="px-4 py-2 bg-white/20 text-white rounded-xl font-bold text-xs hover:bg-white/30 transition-all">${i}</button>`;
                } else if (Math.abs(i - currentPage) === 2) {
                    paginationHTML += `<span class="px-2 text-white/40">...</span>`;
                }
            }

            if (currentPage < totalPages) {
                paginationHTML += `<button onclick="changePage(${currentPage + 1})" class="px-4 py-2 bg-white/20 text-white rounded-xl font-bold text-xs hover:bg-white/30 transition-all">Next ‚Üí</button>`;
            }

            paginationHTML += '</div>';
            document.getElementById('pagination-controls').innerHTML = paginationHTML;
        }


        function changePage(page) {
            currentPage = page;
            updatePagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }


        function switchTab(t) {
            currentTab = t;
            currentPage = 1;

            document.getElementById('grid').style.display = (t === 'lb') ? 'none' : 'grid';
            document.getElementById('lb-view').style.display = (t === 'lb') ? 'block' : 'none';
            document.getElementById('feedTab').classList.toggle('tab-active', t==='feed');
            document.getElementById('ordersTab').classList.toggle('tab-active', t==='orders');
            document.getElementById('lbTab').classList.toggle('tab-active', t==='lb');

            const subFilters = document.getElementById('sub-filters');
            const pagination = document.getElementById('pagination-controls');

            if (subFilters) subFilters.style.display = (t === 'feed') ? 'flex' : 'none';

            if (t !== 'lb') {
                updatePagination();
            } else {
                if (pagination) pagination.innerHTML = '';
                fetchLeaderboard();
            }
        }


        function filterFeed(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const container = document.getElementById('grid');
            const cards = Array.from(container.children);
            if (type === 'new') cards.sort((a, b) => parseInt(a.dataset.index) - parseInt(b.dataset.index));
            else if (type === 'hot') cards.sort((a, b) => parseInt(b.dataset.likes || 0) - parseInt(a.dataset.likes || 0));
            cards.forEach(card => container.appendChild(card));

            currentPage = 1;
            updatePagination();
        }


        async function handleBuy(id) {
            if(!wallet) return alert("Connect wallet first!");
            const btn = document.getElementById('btn-'+id); const oldText = btn.innerText;
            btn.innerText = "WAITING..."; btn.disabled = true;
            try {
                const transaction = new solanaWeb3.Transaction().add(solanaWeb3.SystemProgram.transfer({
                    fromPubkey: new solanaWeb3.PublicKey(wallet), toPubkey: new solanaWeb3.PublicKey(RECEIVER_WALLET), lamports: 0.01 * solanaWeb3.LAMPORTS_PER_SOL
                }));
                const { blockhash } = await connection.getLatestBlockhash('finalized');
                transaction.recentBlockhash = blockhash; transaction.feePayer = new solanaWeb3.PublicKey(wallet);
                const { signature } = await window.solana.signAndSendTransaction(transaction);
                btn.innerText = "CONFIRMING...";
                await connection.confirmTransaction(signature, 'confirmed');
                await fetch('/buy', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({wallet, card_id: id, tx: signature}) });
                myUnlocked.push(id); updateUI(); switchTab('orders');
            } catch (err) { alert("Transaction failed: " + err.message); btn.innerText = oldText; btn.disabled = false; }
        }


        function updateUI() {
            document.querySelectorAll('.forecast-card').forEach(c => {
                const id = c.dataset.id;
                if(myUnlocked.includes(id)) {
                    c.classList.add('unlocked');
                    const btn = document.getElementById('btn-'+id);
                    if(btn) { btn.innerText = "UNLOCKED"; btn.className = "buy-btn w-full py-4 rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] btn-unlocked"; btn.onclick = null; }
                }
                if(myLiked.includes(id)) document.getElementById('like-btn-'+id)?.classList.add('active');
            });
            updatePagination();
        }

        async function fetchLeaderboard() {
            const listContainer = document.getElementById('lb-list');
            listContainer.innerHTML = '<p class="text-center py-10 opacity-50">Loading...</p>';
            try {
                const r = await fetch(`/stats/${currentPeriod}`);
                const data = await r.json();
                const list = data[currentCat] || [];
                listContainer.innerHTML = list.map((u, i) => `
                    <div class="flex justify-between items-center p-4 bg-slate-50/50 rounded-2xl border border-slate-100">
                        <div class="flex items-center gap-4">
                            <span class="font-black text-slate-300 w-6">#${i+1}</span>
                            <img src="https://unavatar.io/twitter/${u.x || 'solana'}" class="h-10 w-10 rounded-full border-2 border-white shadow-sm">
                            <div>
                                <p class="font-black text-sm">${u.wallet.slice(0,6)}...${u.wallet.slice(-4)}</p>
                                ${u.x ? `<a href="https://x.com/${u.x}" target="_blank" class="text-[10px] text-blue-500 font-bold">@${u.x}</a>` : ''}
                            </div>
                        </div>
                        <span class="font-black text-blue-600 text-sm">${u.count} ${currentCat.toUpperCase()}</span>
                    </div>
                `).join('') || '<p class="text-center opacity-30 py-10 font-black">NO DATA</p>';
            } catch(e) { listContainer.innerHTML = '<p class="text-center text-red-400 py-10">Error loading data</p>'; }
        }


        function changePeriod(p, btn) { currentPeriod = p; document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active', 'bg-white', 'shadow-sm')); btn.classList.add('active', 'bg-white', 'shadow-sm'); fetchLeaderboard(); }
        function switchLBCat(c, btn) { currentCat = c; document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); fetchLeaderboard(); }


        async function handleLike(id, btn) {
            if(!wallet) return alert("Connect wallet first!");
            btn.classList.toggle('active');
            const count = btn.querySelector('.like-count');
            count.innerText = parseInt(count.innerText) + (btn.classList.contains('active') ? 1 : -1);
            await fetch('/like', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({wallet, card_id: id}) });
        }


        function openProfile() { if(!wallet) return alert("Connect wallet first!"); document.getElementById('profileModal').classList.remove('hidden'); }
        function closeProfile() { document.getElementById('profileModal').classList.add('hidden'); }
        async function saveX() {
            const x = document.getElementById('xInput').value.replace('@','');
            await fetch('/save_profile', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({wallet, x_handle: x}) });
            closeProfile(); updateAvatar();
        }


        document.addEventListener('DOMContentLoaded', resetState);
        window.addEventListener('pageshow', (event) => { if (event.persisted) resetState(); });
    </script>
</body>
</html>
